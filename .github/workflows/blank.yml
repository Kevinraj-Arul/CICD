name: sample-dev

on:
  push:
    branches:
      - main

jobs:
# ==========================================================================
# JOB 1: VALIDATE + EXECUTE NOTEBOOKS
# ==========================================================================
  validate:
    name: Validate Databricks Bundle & Run Notebook Tests
    runs-on: ubuntu-latest
    continue-on-error: false

    env:
      DATABRICKS_HOST: https://dbc-3c33e389-a9f2.cloud.databricks.com/
      DATABRICKS_TOKEN: dapi73ec3cdf554cb9a35bad7e8376f36164

    steps:
      # Step 1: Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Databricks CLI
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      # Step 3: Convert .py files to Databricks notebooks
      - name: Ensure .py files are Databricks notebooks
        shell: pwsh
        run: |
          Get-ChildItem -Path "${{ github.workspace }}" -Filter "*.py" -Recurse | ForEach-Object {
            if (-not (Get-Content $_.FullName -TotalCount 1 | Select-String "Databricks notebook source")) {
              ("# Databricks notebook source`n" + (Get-Content $_.FullName -Raw)) | Set-Content $_.FullName
            }
          }

      # Step 4: Validate Databricks Asset Bundle (CONFIG VALIDATION)
      - name: Validate Databricks bundle
        run: databricks bundle validate --target dev

      # Step 5: Run Databricks job to execute notebooks (RUNTIME VALIDATION)
      # IMPORTANT: Replace 123456789 with your real Databricks Job ID
      - name: Run notebook validation job
        run: databricks jobs run-now 542975920282104


# ==========================================================================
# JOB 2: DEPLOY ONLY IF VALIDATION PASSES
# ==========================================================================
  deploy:
    name: Deploy Databricks Asset Bundle
    needs: validate
    if: needs.validate.result == 'success'
    runs-on: ubuntu-latest
    continue-on-error: false

    env:
      DATABRICKS_HOST: https://dbc-3c33e389-a9f2.cloud.databricks.com/
      DATABRICKS_TOKEN: dapi73ec3cdf554cb9a35bad7e8376f36164

    steps:
      # Step 1: Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Databricks CLI
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      # Step 3: Deploy Databricks Asset Bundle
      - name: Deploy Databricks bundle
        run: databricks bundle deploy --target dev
